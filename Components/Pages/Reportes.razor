@page "/reportes"
@using Facturar.Components.Data.Reportes
@using Facturar.Components.Servicio
@rendermode InteractiveServer
@inject ControladorFacturacion Controlador
@inject NavigationManager Navigation

<PageTitle>Reporte Anual</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Reporte Anual</h1>
    <div>
        <a href="/" class="btn btn-secondary">Volver al Inicio</a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="anio" class="col-form-label">Año:</label>
            </div>
            <div class="col-auto">
                <InputNumber id="anio" class="form-control" @bind-Value="anioParaBuscar" />
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="HandleGenerarReporte">Generar Reporte</button>
            </div>
        </div>
    </div>
</div>

@if (cargando)
{
    <p><em>Generando reporte...</em></p>
}
else if (reporte != null)
{
    <div class="card shadow-sm">
        <div class="card-header">
            <h2 class="mb-0">Reporte del Año: @reporte.Anio</h2>
        </div>
        <div class="card-body">
            @if (!reporte.Meses.Any(m => m.Facturas.Any()))
            {
                <p class="text-muted">No se encontraron facturas para el año @reporte.Anio.</p>
            }
            else
            {
                <div class="accordion" id="reporte-accordion">
                    @foreach (var mes in reporte.Meses.Where(m => m.Facturas.Any()))
                    {
                        <div class="accordion-item">
                            <h3 class="accordion-header" id="heading-@mes.NumeroMes">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@mes.NumeroMes" aria-expanded="false" aria-controls="collapse-@mes.NumeroMes">
                                    @mes.NombreMes - Total: @mes.TotalMes.ToString("C")
                                </button>
                            </h3>
                            <div id="collapse-@mes.NumeroMes" class="accordion-collapse collapse" aria-labelledby="heading-@mes.NumeroMes" data-bs-parent="#reporte-accordion">
                                <div class="accordion-body">
                                    <table class="table table-sm table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Nº Factura</th>
                                                <th>Usuario</th>
                                                <th>Fecha</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var factura in mes.Facturas)
                                            {
                                                <tr>
                                                    <td>
                                                        <a href="/factura/@factura.FacturaID">@factura.NombreFactura</a>
                                                    </td>
                                                    <td>@factura.NombreUsuario</td>
                                                    <td>@factura.FechaCreacion.ToString("d")</td>
                                                    <td>@factura.Total.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-dark">
                                                <td colspan="3" class="text-end fw-bold">Total @mes.NombreMes:</td>
                                                <td class="fw-bold">@mes.TotalMes.ToString("C")</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <hr class="my-4" />

                <div class="alert alert-success fs-4 text-center">
                    <strong>Total Anual (@reporte.Anio): @reporte.TotalAnual.ToString("C")</strong>
                </div>
            }
        </div>
    </div>
}

@code {
    private int anioParaBuscar = DateTime.Today.Year;
    private ReporteAnual reporte;
    private bool cargando = false;

    private async Task HandleGenerarReporte()
    {
        cargando = true;
        reporte = null;
        StateHasChanged();

        reporte = await Controlador.GenerarReporteAnualAsync(anioParaBuscar);
        cargando = false;
        StateHasChanged();
    }
}