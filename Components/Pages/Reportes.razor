@page "/reportes"
@using Facturar.Components.Data.Reportes
@using Facturar.Components.Servicio
@rendermode InteractiveServer
@inject ControladorFacturacion Controlador
@inject NavigationManager Navigation

<PageTitle>Reportes - FacturaPop</PageTitle>

<div class="container-fluid px-md-5 py-4" style="max-width: 1200px;">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="headline-large mb-1">Reportes</h2>
            <p class="text-on-surface-variant mb-0">Resumen financiero anual por cliente</p>
        </div>
        <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i> Inicio
        </a>
    </div>

    <div class="card border-0 mb-5" style="background-color: var(--md-sys-color-surface-container);">
        <div class="card-body p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="usuario" class="form-label">Cliente / Usuario</label>
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                        <InputText id="usuario" class="form-control border-start-0 ps-0" 
                                   placeholder="Buscar cliente..." 
                                   @bind-Value="nombreUsuarioParaBuscar" />
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="anio" class="form-label">Año Fiscal</label>
                    <InputNumber id="anio" class="form-control" @bind-Value="anioParaBuscar" />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" @onclick="HandleGenerarReporte" disabled="@cargando">
                        @if (cargando)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span> <span>Procesando...</span>
                        }
                        else
                        {
                            <i class="bi bi-bar-chart-fill me-2"></i> <span>Generar Informe</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(errorEnReporte))
    {
        <div class="alert alert-danger d-flex align-items-center mb-4">
            <i class="bi bi-exclamation-octagon-fill me-3 fs-4"></i>
            <div>@errorEnReporte</div>
        </div>
    }

    @if (reporte != null)
    {
        <div class="invoice-paper fade-in-up">
            
            <div class="text-center mb-5 border-bottom pb-4">
                <div class="small text-uppercase fw-bold text-primary mb-2">Informe de Facturación</div>
                <h3 class="display-6 fw-bold mb-1">@nombreUsuarioParaBuscar</h3>
                <span class="badge rounded-pill border px-3 py-2 text-muted">
                    Ejercicio @reporte.Anio
                </span>
            </div>

            @if (!reporte.Meses.Any(m => m.Facturas.Any()))
            {
                <div class="text-center py-5 opacity-50">
                    <i class="bi bi-folder-x display-1 mb-3 d-block"></i>
                    <p>No hay registros para este periodo.</p>
                </div>
            }
            else
            {
                <div class="accordion accordion-flush" id="reporteAccordion">
                    @foreach (var mes in reporte.Meses.Where(m => m.Facturas.Any()))
                    {
                        <div class="accordion-item mb-3 border rounded overflow-hidden shadow-sm">
                            <h2 class="accordion-header" id="heading-@mes.NumeroMes">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#collapse-@mes.NumeroMes">
                                    <div class="d-flex justify-content-between w-100 me-3 align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-primary-subtle text-primary rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:32px;height:32px">
                                                <small class="fw-bold">@mes.NumeroMes</small>
                                            </div>
                                            <span class="fw-medium">@mes.NombreMes</span>
                                        </div>
                                        <span class="fw-bold text-primary">@mes.TotalMes.ToString("C")</span>
                                    </div>
                                </button>
                            </h2>
                            
                            <div id="collapse-@mes.NumeroMes" class="accordion-collapse collapse" 
                                 data-bs-parent="#reporteAccordion">
                                <div class="accordion-body p-0">
                                    <table class="table table-hover mb-0 bg-white">
                                        <thead class="bg-light border-bottom">
                                            <tr>
                                                <th class="ps-4">Folio</th>
                                                <th>Fecha</th>
                                                <th class="text-end pe-4">Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var factura in mes.Facturas)
                                            {
                                                <tr>
                                                    <td class="ps-4">
                                                        <a href="/factura/@factura.FacturaID" class="text-decoration-none fw-bold">
                                                            #@factura.NombreFactura
                                                        </a>
                                                    </td>
                                                    <td class="text-muted">@factura.FechaCreacion.ToString("d MMMM")</td>
                                                    <td class="text-end pe-4 fw-medium">@factura.Total.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="total-summary mt-5 p-4 rounded-4 text-white d-flex justify-content-between align-items-center">
                    <div>
                        <span class="d-block text-white-50 text-uppercase small fw-bold">Ingreso Total Anual</span>
                        <span class="h5 mb-0">Acumulado @reporte.Anio</span>
                    </div>
                    <div class="display-4 fw-bold">
                        @reporte.TotalAnual.ToString("C")
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .invoice-paper {
        background: white;
        padding: 3rem;
        border-radius: var(--md-sys-shape-corner-large);
        box-shadow: var(--md-sys-elevation-1);
        min-height: 400px;
    }

    .accordion-button:not(.collapsed) {
        background-color: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
    }
    
    /* CORRECCIÓN DE VARIABLES DE COLOR */
    .total-summary {
        background: linear-gradient(135deg, var(--md-sys-color-tertiary) 0%, var(--md-sys-color-primary) 100%);
        box-shadow: var(--md-sys-elevation-2);
    }

    .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
    @@keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

@code {
    private int anioParaBuscar = DateTime.Today.Year;
    private string nombreUsuarioParaBuscar = string.Empty;
    private ReporteAnual reporte;
    private bool cargando = false;
    private string errorEnReporte = string.Empty;

    private async Task HandleGenerarReporte()
    {
        cargando = true;
        reporte = null;
        errorEnReporte = string.Empty;
        await Task.Delay(200); 
        
        try
        {
            reporte = await Controlador.GenerarReporteAnualAsync(anioParaBuscar, nombreUsuarioParaBuscar);
        }
        catch (Exception ex)
        {
            errorEnReporte = ex.Message;
        }

        cargando = false;
        StateHasChanged();
    }
}