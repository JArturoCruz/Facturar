@page "/facturador"
@using Facturar.Components.Data
@using Facturar.Components.Servicio
@rendermode InteractiveServer
@inject ControladorFacturacion Controlador
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Facturador - FacturaPop</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="fw-bold text-primary">
            @(Controlador.FacturaIDEnModificacion.HasValue ? "Modificar Factura" : "Nueva Factura")
        </h1>
        <p class="text-muted mb-0">Agrega productos y genera tu comprobante.</p>
    </div>

    <div class="btn-group shadow-sm">
        <a href="/" class="btn btn-outline-secondary" title="Inicio">
            <i class="bi bi-house"></i>
        </a>
        <a href="/facturas" class="btn btn-secondary">
            <i class="bi bi-folder2-open"></i> Ver Guardadas
        </a>
        <button class="btn btn-outline-danger" @onclick="LimpiarFacturador" title="Limpiar todo">
            <i class="bi bi-eraser"></i> Limpiar
        </button>
    </div>
</div>

@if (Controlador != null && Controlador.DraftItem != null)
{
    <div class="card border-0 shadow-sm mb-5" style="background: #f8fafc;">
        <div class="card-body p-4">
            <h5 class="card-title text-uppercase text-muted small fw-bold mb-3">
                @(Controlador.DraftItem.Identificador == 0 ? "➕ Agregar Item" : "✏️ Editando Item")
            </h5>

            <EditForm Model="Controlador.DraftItem" OnValidSubmit="OnFormSubmit">
                <DataAnnotationsValidator />

                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label for="producto" class="form-label fw-medium">Descripción del Producto</label>
                        <InputText id="producto" class="form-control form-control-lg bg-white"
                                   placeholder="Ej. Consultoría Técnica"
                                   @bind-Value="Controlador.DraftItem.Producto"
                                   @bind-Value:after="Controlador.GuardarDraftItemAsync" />
                        <ValidationMessage For="() => Controlador.DraftItem.Producto" />
                    </div>

                    <div class="col-md-2">
                        <label for="cantidad" class="form-label fw-medium">Cant.</label>
                        <InputNumber id="cantidad" class="form-control form-control-lg bg-white text-center"
                                     @bind-Value="Controlador.DraftItem.Cantidad"
                                     @bind-Value:after="Controlador.GuardarDraftItemAsync" />
                        <ValidationMessage For="() => Controlador.DraftItem.Cantidad" />
                    </div>

                    <div class="col-md-3">
                        <label for="precio" class="form-label fw-medium">Precio Unit.</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white text-muted">$</span>
                            <InputNumber id="precio" class="form-control bg-white"
                                         @bind-Value="Controlador.DraftItem.PrecioUnitario"
                                         @bind-Value:after="Controlador.GuardarDraftItemAsync" />
                        </div>
                        <ValidationMessage For="() => Controlador.DraftItem.PrecioUnitario" />
                    </div>

                    <div class="col-md-2 d-grid">
                        @if (Controlador.DraftItem.Identificador == 0)
                        {
                            <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                                <i class="bi bi-plus-lg"></i> Agregar
                            </button>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-grow-1">Ok</button>
                                <button type="button" class="btn btn-outline-secondary" @onclick="CancelarEdicion">✖</button>
                            </div>
                        }
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
}

<div class="invoice-paper-draft fade-in">

    <div class="draft-ribbon">
        <span>@(Controlador.FacturaIDEnModificacion.HasValue ? "MODO EDICIÓN" : "BORRADOR")</span>
    </div>

    <div class="row justify-content-between align-items-start mb-5">
        <div class="col-md-6">
            <div class="brand-text mb-4">
                <span class="icon">🔷</span> Factura<span class="bold">Pop</span>
            </div>

            <div class="form-group mb-3">
                <label class="text-uppercase text-muted small fw-bold mb-1">Cliente / Razón Social</label>
                <div class="input-wrapper">
                    <i class="bi bi-person text-muted me-2"></i>
                    <InputText @bind-Value="Controlador.NombreUsuarioEnBorrador"
                               @bind-Value:after="Controlador.GuardarUsuarioEnBorradorAsync"
                               class="form-control-plaintext form-control-lg fw-bold text-primary"
                               placeholder="Ingrese el nombre del cliente..." />
                </div>
            </div>
        </div>

        <div class="col-md-4 text-md-end">
            <div class="form-group">
                <label class="text-uppercase text-muted small fw-bold mb-1">Fecha de Emisión</label>
                <div class="input-wrapper justify-content-md-end">
                    <InputDate @bind-Value="Controlador.FechaFacturaEnBorrador"
                               @bind-Value:after="Controlador.GuardarFechaFacturaEnBorradorAsync"
                               class="form-control form-control-sm w-auto d-inline-block text-end border-0 bg-light rounded px-2" />
                </div>
            </div>
            <div class="mt-2 text-muted small">
                @if (Controlador.FacturaIDEnModificacion.HasValue)
                {
                    <span class="badge bg-warning text-dark">Editando ID: #@Controlador.FacturaIDEnModificacion</span>
                }
                else
                {
                    <span class="badge bg-light text-secondary border">Nueva Asignación de Folio</span>
                }
            </div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(errorAlGuardar))
    {
        <div class="alert alert-danger shadow-sm border-0 mb-4">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @errorAlGuardar
        </div>
    }

    <div class="table-responsive mb-4" style="min-height: 200px;">
        <table class="table table-borderless align-middle">
            <thead class="border-bottom border-2">
                <tr class="text-uppercase text-muted small">
                    <th style="width: 50%">Descripción</th>
                    <th class="text-center" style="width: 15%">Cant.</th>
                    <th class="text-end" style="width: 15%">Precio</th>
                    <th class="text-end" style="width: 15%">Total</th>
                    <th style="width: 5%"></th>
                </tr>
            </thead>
            <tbody>
                @if (itemsFactura.Any())
                {
                    @foreach (var item in itemsFactura)
                    {
                        <tr class="invoice-row-hover">
                            <td class="fw-medium text-dark">@item.Producto</td>
                            <td class="text-center bg-light rounded-3 my-1">@item.Cantidad</td>
                            <td class="text-end text-muted">@item.PrecioUnitario.ToString("C")</td>
                            <td class="text-end fw-bold">@item.Subtotal.ToString("C")</td>
                            <td class="text-end">
                                <div class="btn-group opacity-50 hover-100">
                                    <button class="btn btn-link btn-sm p-0 text-primary me-2" @onclick="() => PrepararEdicion(item)" title="Editar">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-link btn-sm p-0 text-danger" @onclick="() => EliminarItemDeFactura(item)" title="Eliminar">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <div class="mb-2" style="font-size: 2rem; opacity: 0.2;">🛒</div>
                            <p class="mb-0">La lista está vacía.</p>
                            <small>Agrega productos usando el panel superior.</small>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="row mt-4 pt-3 border-top">
        <div class="col-md-6 d-flex align-items-end">
            @if (itemsFactura.Any())
            {
                <button class="btn btn-lg w-100 @(Controlador.FacturaIDEnModificacion.HasValue ? "btn-warning text-white" : "btn-primary") shadow"
                        @onclick="GuardarFactura">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    @(Controlador.FacturaIDEnModificacion.HasValue ? "Actualizar Factura" : "Finalizar y Guardar")
                </button>
            }
        </div>
        <div class="col-md-6">
            <div class="bg-light p-3 rounded text-end">
                <small class="text-uppercase text-muted fw-bold">Total a Pagar</small>
                <div class="display-6 fw-bold text-dark">@TotalFactura.ToString("C")</div>
            </div>
        </div>
    </div>
</div>

<style>
    .invoice-paper-draft {
        background: white;
        padding: 3rem;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.06);
        position: relative;
        overflow: hidden;
        border: 1px solid #eef2f6;
    }

    .draft-ribbon {
        position: absolute;
        top: 20px;
        right: -35px;
        background: #f1f5f9;
        color: #94a3b8;
        transform: rotate(45deg);
        padding: 5px 40px;
        font-size: 0.7rem;
        font-weight: bold;
        letter-spacing: 1px;
        pointer-events: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .brand-text {
        font-family: 'Poppins', sans-serif;
        font-size: 1.5rem;
        color: var(--blue-deep);
        font-weight: 500;
    }

        .brand-text .bold {
            font-weight: 700;
            color: var(--blue-royal);
        }

    .input-wrapper {
        display: flex;
        align-items: center;
        border-bottom: 2px solid #e2e8f0;
        transition: border-color 0.3s;
    }

        .input-wrapper:focus-within {
            border-color: var(--blue-royal);
        }

    .form-control-plaintext:focus {
        outline: none;
    }

    .invoice-row-hover:hover td {
        background-color: #f8fafc;
    }

    .hover-100 {
        transition: opacity 0.2s;
    }

    .invoice-row-hover:hover .hover-100 {
        opacity: 1 !important;
    }

    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    private List<FacturaItem> itemsFactura = new List<FacturaItem>();
    private decimal TotalFactura => itemsFactura.Sum(item => item.Subtotal);
    private string errorAlGuardar = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Controlador.CargarEstadoBorradorAsync();
        itemsFactura = await Controlador.ObtenerItems();
    }

    private async Task OnFormSubmit()
    {
        await Controlador.GuardarCambiosDraftItemAsync();
        itemsFactura = await Controlador.ObtenerItems();
        StateHasChanged();
    }

    private async Task EliminarItemDeFactura(FacturaItem item)
    {
        await Controlador.EliminarItem(item.Identificador);
        itemsFactura = await Controlador.ObtenerItems();
        StateHasChanged();
    }

    private void PrepararEdicion(FacturaItem item)
    {
        Controlador.CargarItemParaEdicion(item);
    }

    private async Task CancelarEdicion()
    {
        await Controlador.CancelarEdicionAsync();
        StateHasChanged();
    }

    private async Task GuardarFactura()
    {
        errorAlGuardar = string.Empty;
        try
        {
            if (Controlador.FacturaIDEnModificacion.HasValue)
            {
                await Controlador.ActualizarFacturaGuardadaAsync(
                    Controlador.FacturaIDEnModificacion.Value,
                    Controlador.FechaFacturaEnBorrador,
                    Controlador.NombreUsuarioEnBorrador,
                    itemsFactura
                );
            }
            else
            {
                await Controlador.GuardarFacturaActualAsync(
                    Controlador.FechaFacturaEnBorrador,
                    Controlador.NombreUsuarioEnBorrador,
                    itemsFactura
                );
            }
            itemsFactura = await Controlador.ObtenerItems();
            StateHasChanged();
            Navigation.NavigateTo("/facturas");
        }
        catch (Exception ex)
        {
            errorAlGuardar = ex.Message;
            StateHasChanged();
        }
    }

    private async Task LimpiarFacturador()
    {
        var mensaje = "Se limpiará el borrador actual. Si estás modificando una factura, se cancelará la modificación.\n\n¿Deseas continuar?";
        bool confirmado = await JSRuntime.InvokeAsync<bool>("confirm", mensaje);

        if (confirmado)
        {
            await Controlador.LimpiarEstadoBorradorAsync();
            itemsFactura = await Controlador.ObtenerItems();
            errorAlGuardar = string.Empty;
            StateHasChanged();
        }
    }
}