@page "/facturador"
@using Facturar.Components.Data
@using Facturar.Components.Servicio
@rendermode InteractiveServer
@inject ControladorFacturacion Controlador
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Facturador</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    @if (Controlador.FacturaIDEnModificacion.HasValue)
    {
        <h1>Modificando Factura</h1>
    }
    else
    {
        <h1>Crear Nueva Factura</h1>
    }

    <div>
        <a href="/facturas" class="btn btn-secondary me-2">Ver Facturas Guardadas</a>
        <button class="btn btn-info" @onclick="LimpiarFacturador">Nueva Factura (Limpiar)</button>
    </div>
</div>


@if (Controlador != null && Controlador.DraftItem != null)
{
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h3>@(Controlador.DraftItem.Identificador == 0 ? "Agregar Producto" : $"Editando: {Controlador.DraftItem.Producto}")</h3>
        </div>
        <div class="card-body">
            <EditForm Model="Controlador.DraftItem" OnValidSubmit="OnFormSubmit">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label for="producto" class="form-label">Producto:</label>
                    <InputText id="producto" class="form-control"
                               @bind-Value="Controlador.DraftItem.Producto"
                               @bind-Value:after="Controlador.GuardarDraftItemAsync" />
                    <ValidationMessage For="() => Controlador.DraftItem.Producto" />
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="cantidad" class="form-label">Cantidad:</label>
                        <InputNumber id="cantidad" class="form-control"
                                     @bind-Value="Controlador.DraftItem.Cantidad"
                                     @bind-Value:after="Controlador.GuardarDraftItemAsync" />
                        <ValidationMessage For="() => Controlador.DraftItem.Cantidad" />
                    </div>
                    <div class="col-md-6">
                        <label for="precio" class="form-label">Precio Unitario:</label>
                        <InputNumber id="precio" class="form-control"
                                     @bind-Value="Controlador.DraftItem.PrecioUnitario"
                                     @bind-Value:after="Controlador.GuardarDraftItemAsync" />
                        <ValidationMessage For="() => Controlador.DraftItem.PrecioUnitario" />
                    </div>
                </div>

                @if (Controlador.DraftItem.Identificador == 0)
                {
                    <button type="submit" class="btn btn-primary">Agregar Producto</button>
                }
                else
                {
                    <button type="submit" class="btn btn-success">Actualizar Producto</button>
                    <button type="button" class="btn btn-secondary ms-2" @onclick="CancelarEdicion">Cancelar</button>
                }
            </EditForm>
        </div>
    </div>
}
else
{
    <p>Cargando controlador...</p>
}


<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Resumen de Factura Actual</h3>

        @if (itemsFactura.Any())
        {
            <div class="d-flex">
                <InputText @bind-Value="Controlador.NombreFacturaEnBorrador"
                           @bind-Value:after="Controlador.GuardarNombreFacturaEnBorradorAsync"
                           class="form-control me-2"
                           placeholder="Nombre de la factura" />

                @if (Controlador.FacturaIDEnModificacion.HasValue)
                {
                    <button class="btn btn-warning" @onclick="GuardarFactura">Actualizar</button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="GuardarFactura">Guardar</button>
                }
            </div>
        }
    </div>
    <div class="card-body">
        @if (!string.IsNullOrWhiteSpace(errorAlGuardar))
        {
            <div class="alert alert-danger">@errorAlGuardar</div>
        }

        @if (itemsFactura.Any())
        {
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in itemsFactura)
                    {
                        <tr>
                            <td>@item.Producto</td>
                            <td>@item.Cantidad</td>
                            <td>@item.PrecioUnitario.ToString("C")</td>
                            <td>@item.Subtotal.ToString("C")</td>
                            <td>
                                <button class="btn btn-primary btn-sm me-1" @onclick="() => PrepararEdicion(item)">
                                    ✏️
                                </button>
                                <button class="btn btn-danger btn-sm" @onclick="() => EliminarItemDeFactura(item)">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td colspan="4" class="text-end fw-bold">TOTAL:</td>
                        <td class="fw-bold">@TotalFactura.ToString("C")</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        }
        else
        {
            <p class="text-center text-muted">Aún no hay productos en la factura.</p>
        }
    </div>
</div>


@code {
    private List<FacturaItem> itemsFactura = new List<FacturaItem>();
    private decimal TotalFactura => itemsFactura.Sum(item => item.Subtotal);
    private string errorAlGuardar = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await Controlador.CargarEstadoBorradorAsync();
        itemsFactura = await Controlador.ObtenerItems();
    }

    private async Task OnFormSubmit()
    {
        await Controlador.GuardarCambiosDraftItemAsync();
        itemsFactura = await Controlador.ObtenerItems();
        StateHasChanged();
    }

    private async Task EliminarItemDeFactura(FacturaItem item)
    {
        await Controlador.EliminarItem(item.Identificador);
        itemsFactura = await Controlador.ObtenerItems();
        StateHasChanged();
    }

    private void PrepararEdicion(FacturaItem item)
    {
        Controlador.CargarItemParaEdicion(item);
    }

    private async Task CancelarEdicion()
    {
        await Controlador.CancelarEdicionAsync();
        StateHasChanged();
    }

    private async Task GuardarFactura()
    {
        errorAlGuardar = string.Empty;
        try
        {
            if (Controlador.FacturaIDEnModificacion.HasValue)
            {
                await Controlador.ActualizarFacturaGuardadaAsync(
                    Controlador.FacturaIDEnModificacion.Value,
                    Controlador.NombreFacturaEnBorrador,
                    itemsFactura
                );
            }
            else
            {
                await Controlador.GuardarFacturaActualAsync(Controlador.NombreFacturaEnBorrador, itemsFactura);
            }

            itemsFactura = await Controlador.ObtenerItems();
            StateHasChanged();

            Navigation.NavigateTo("/facturas");
        }
        catch (Exception ex)
        {
            errorAlGuardar = ex.Message;
            StateHasChanged();
        }
    }

    private async Task LimpiarFacturador()
    {
        var mensaje = "Se limpiará el borrador actual. Si estás modificando una factura, se cancelará la modificación.\n\n¿Deseas continuar?";
        bool confirmado = await JSRuntime.InvokeAsync<bool>("confirm", mensaje);

        if (confirmado)
        {
            await Controlador.LimpiarEstadoBorradorAsync();
            itemsFactura = await Controlador.ObtenerItems();
            errorAlGuardar = string.Empty;
            StateHasChanged();
        }
    }
}